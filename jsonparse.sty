% File: jsonparse.sty 
% Copyright 2024 Jasper Habicht (mail@jasperhabicht.de).
% 
% This work may be distributed and/or modified under the
% conditions of the LaTeX Project Public License version 1.3c,
% available at http://www.latex-project.org/lppl/.
% 
% This file is part of the `jsonparse'  package (The Work in LPPL)
% and all files in that bundle must be distributed together.
% 
% This work has the LPPL maintenance status `author-maintained'.
% 
\ProvidesExplPackage {jsonparse} {2024-04-08} {0.2.8} 
  {JSON Parse}

\bool_new:N \l_jsonparse_debug_mode_bool
\keys_define:nn { jsonparse } { 
    debug .bool_set:N = \l_jsonparse_debug_mode_bool ,
    debug .default:n  = { true } ,
}
\ProcessKeyOptions [ jsonparse ]

\msg_new:nnn { jsonparse } { parsing-error } {
  \msg_warning_text:n { jsonparse } \iow_newline:
  Could ~ not ~ parse ~ JSON. \iow_newline:
  Parsing ~ error ~ at ~ key ~ `#1` ~ with ~ value ~ `#2`. 
}

\msg_new:nnn { jsonparse } { debug-info } {
  #1
}

% ===
	
\str_new:N \l_jsonparse_child_sep_str
\str_set:Nn \l_jsonparse_child_sep_str { . }
\str_new:N \l_jsonparse_array_sep_left_str
\str_set:Nn \l_jsonparse_array_sep_left_str { [ }
\str_new:N \l_jsonparse_array_sep_right_str
\str_set:Nn \l_jsonparse_array_sep_right_str { ] }
\str_new:N \l_jsonparse_true_str
\str_set:Nn \l_jsonparse_true_str { true }
\str_new:N \l_jsonparse_false_str
\str_set:Nn \l_jsonparse_false_str { false }
\str_new:N \l_jsonparse_null_str
\str_set:Nn \l_jsonparse_null_str { null }

\bool_new:N \l_jsonparse_array_index_zero_based_bool
\bool_set_true:N \l_jsonparse_array_index_zero_based_bool

\NewDocumentCommand { \JSONParseSetChildSeparator } { m } {
  \str_set:Nn \l_jsonparse_child_sep_str { #1 }
}

\NewDocumentCommand { \JSONParseSetArraySeparator } { m m } {
  \str_set:Nn \l_jsonparse_array_sep_left_str { #1 }
  \str_set:Nn \l_jsonparse_array_sep_right_str { #2 }
}

\NewDocumentCommand { \JSONParseSetTrueString } { m } {
  \str_set:Nn \l_jsonparse_true_str { #1 }
}

\NewDocumentCommand { \JSONParseSetFalseString } { m } {
  \str_set:Nn \l_jsonparse_false_str { #1 }
}

\NewDocumentCommand { \JSONParseSetNullString } { m } {
  \str_set:Nn \l_jsonparse_null_str { #1 }
}

\NewDocumentCommand { \JSONParseSetArrayIndexZeroBased } { } {
  \bool_set_true:N \l_jsonparse_array_index_zero_based_bool
}

\NewDocumentCommand { \JSONParseSetArrayIndexOneBased } { } {
  \bool_set_false:N \l_jsonparse_array_index_zero_based_bool
}

% ===

\cs_generate_variant:Nn \str_count:n { e }
\cs_generate_variant:Nn \str_head:n { e }
\cs_generate_variant:Nn \str_head_ignore_spaces:n { e }
\cs_generate_variant:Nn \str_if_eq_p:nn { en , ee }
\cs_generate_variant:Nn \str_item_ignore_spaces:nn { en }
\cs_generate_variant:Nn \str_range:nnn { nne , nen , nee , een }
\cs_generate_variant:Nn \str_replace_once:Nnn { Nen }
\cs_generate_variant:Nn \str_remove_once:Nn { Ne }
\cs_generate_variant:Nn \str_set:Nn { Ne }
\cs_generate_variant:Nn \prop_gput:Nnn { Nee }
\cs_generate_variant:Nn \seq_use:Nn { Ne }
\cs_generate_variant:Nn \msg_log:nnn { nno }

\prg_generate_conditional_variant:Nnn \str_case:nn { en } { F }
\prg_generate_conditional_variant:Nnn \str_case_e:nn { en , ee } { F }
\prg_generate_conditional_variant:Nnn \str_if_eq:nn { ee } { T }
\prg_generate_conditional_variant:Nnn \str_if_eq:nn { en } { T , TF }

\prop_new:N \g_jsonparse_entries_prop

\str_new:N \l__jsonparse_json_str
\str_new:N \l__jsonparse_input_str
\str_new:N \l__jsonparse_prefix_str
\str_new:N \l__jsonparse_key_str
\str_new:N \l__jsonparse_val_str
\str_new:N \l__jsonparse_remainder_str
\str_new:N \l__jsonparse_object_prefix_str
\str_new:N \l__jsonparse_array_prefix_str

\int_new:N \l__jsonparse_array_item_int

\bool_new:N \l__prop_map_first_bool

\ior_new:N \l__jsonparse_json_ior
	
% ===

\cs_new:Npn \jsonparse_parse_to_prop:Nn #1#2 {
  \prop_gclear:N \g_jsonparse_entries_prop
  \jsonparse_parse:n {#2}
  \prop_set_eq:NN #1 \g_jsonparse_entries_prop 
}

\cs_new:Npn \_jsonparse_remove_leading_spaces:N #1 {
  \bool_while_do:nn { \str_if_eq_p:en { \str_head:e { #1 } } { ~ } } {
    \str_remove_once:Nn #1 { ~ }
  }
}

\cs_new:Npn \jsonparse_parse:n #1 {
  \bool_if:NT \l_jsonparse_debug_mode_bool {
    \msg_log:nne { jsonparse } { debug-info } {
      \iow_newline: 
      Parsing ~ JSON ~ ... 
    } 
  }
  \str_set:Ne \l__jsonparse_input_str {#1}
  \_jsonparse_remove_leading_spaces:N \l__jsonparse_input_str
  \str_case_e:enF { \str_head_ignore_spaces:e { \l__jsonparse_input_str } } {
    { \c_left_brace_str } { 
      \exp_last_unbraced:Ne 
        \__jsonparse_parse_object_begin:w \l__jsonparse_input_str \q_stop 
    }
    { \c_right_brace_str } { 
      \exp_last_unbraced:Ne 
        \__jsonparse_parse_object_end:w \l__jsonparse_input_str \q_stop 
    }
    { [ } { 
      \exp_last_unbraced:Ne 
        \__jsonparse_parse_array_begin:w \l__jsonparse_input_str \q_stop 
    }
    { ] } { 
      \exp_last_unbraced:Ne 
        \__jsonparse_parse_array_end:w \l__jsonparse_input_str \q_stop 
    }
    { " } { 
      \exp_last_unbraced:Ne 
        \__jsonparse_parse_string_key:w \l__jsonparse_input_str \q_stop 
    }
  } {
    % other
    \exp_last_unbraced:Ne 
      \__jsonparse_parse_other:w \l__jsonparse_input_str \q_stop 
  }
}

% ===

\cs_new:Npn \__jsonparse_parse_object_begin:w #1 \q_stop {
  \__jsonparse_array_key_set:
  \group_begin:
  \str_set:Ne \l__jsonparse_remainder_str {#1}
  \str_remove_once:Ne \l__jsonparse_remainder_str { \c_left_brace_str }
  % object begin
  \bool_if:NT \l_jsonparse_debug_mode_bool {
    \msg_log:nne { jsonparse } { debug-info } {
      (objb) 
    } 
  }
  \str_if_empty:NF \l__jsonparse_key_str {
    \str_set:Ne \l__jsonparse_prefix_str { \l__jsonparse_key_str \l_jsonparse_child_sep_str }
  }
  \__jsonparse_parse_remainder:
}

\cs_new:Npn \__jsonparse_parse_object_end:w #1 \q_stop {
  \group_end:
  \str_set:Ne \l__jsonparse_remainder_str {#1}
  \str_remove_once:Ne \l__jsonparse_remainder_str { \c_right_brace_str }
  % object end
  \bool_if:NT \l_jsonparse_debug_mode_bool {
    \msg_log:nne { jsonparse } { debug-info } {
      (obje) 
    } 
  }
  \__jsonparse_parse_remainder:
}

\cs_new:Npn \__jsonparse_parse_array_begin:w [ #1 \q_stop {
  \__jsonparse_array_key_set:
  \group_begin:
  \str_set:Ne \l__jsonparse_remainder_str {#1}
  % array begin
  \bool_if:NT \l_jsonparse_debug_mode_bool {
    \msg_log:nne { jsonparse } { debug-info } {
      (arrb) 
    }   
  }
  \int_zero:N \l__jsonparse_array_item_int
  \bool_if:NT \l_jsonparse_array_index_zero_based_bool {
    \int_decr:N \l__jsonparse_array_item_int
  }
  \str_set:Ne \l__jsonparse_prefix_str { \l__jsonparse_key_str \l_jsonparse_array_sep_left_str }
  \__jsonparse_parse_remainder:
}

\cs_new:Npn \__jsonparse_parse_array_end:w ] #1 \q_stop {
  \group_end:
  \str_set:Ne \l__jsonparse_remainder_str {#1}
  % array end
  \bool_if:NT \l_jsonparse_debug_mode_bool {
    \msg_log:nne { jsonparse } { debug-info } {
      (arre) 
    } 
  }
  \__jsonparse_parse_remainder:
}

\cs_new:Npn \__jsonparse_array_key_set: {
  \str_if_eq:eeT { \str_item_ignore_spaces:en { \l__jsonparse_prefix_str } { -1 } } 
    { \l_jsonparse_array_sep_left_str } {
    \int_incr:N \l__jsonparse_array_item_int
    \str_set:Ne \l__jsonparse_key_str { 
      \l__jsonparse_prefix_str \int_use:N \l__jsonparse_array_item_int \l_jsonparse_array_sep_right_str 
    }
  }
}

\cs_new:Npn \__jsonparse_parse_string_key:w " #1 " #2 \q_stop {
  \__jsonparse_array_key_set:
  \str_set:Ne \l__jsonparse_remainder_str {#2}
  % key or string?
  \str_if_eq:enTF { \str_head_ignore_spaces:n { #2 } } { : } {
    \str_remove_once:Nn \l__jsonparse_remainder_str { : }
    \str_set:Ne \l__jsonparse_key_str { \l__jsonparse_prefix_str #1 }
  } { 
    \str_set:Ne \l__jsonparse_val_str {#1}
    \prop_gput:Nee \g_jsonparse_entries_prop 
      { \l__jsonparse_key_str } { \l__jsonparse_val_str }
    % string
    \bool_if:NT \l_jsonparse_debug_mode_bool {
      \msg_log:nne { jsonparse } { debug-info } {
        (key) ~ \str_use:N \l__jsonparse_key_str : \iow_newline:
        \iow_char:N \  \iow_char:N \  (str) ~ \str_use:N \l__jsonparse_val_str 
      } 
    }  
  }
  \__jsonparse_parse_remainder:
}

\cs_new:Npn \__jsonparse_parse_other:w #1 \q_stop {
  \__jsonparse_array_key_set:
  \str_set:Ne \l__jsonparse_remainder_str {#1}
  \str_set:Ne \l__jsonparse_input_str {#1}
  \str_replace_once:Nen \l__jsonparse_input_str { \c_right_brace_str } { , }
  \str_replace_once:Nnn \l__jsonparse_input_str { ] } { , }
  \exp_last_unbraced:Ne
    \__jsonparse_parse_other_aux:w \l__jsonparse_input_str \q_stop
}

\cs_new:Npn \__jsonparse_parse_other_aux:w #1 , #2 \q_stop {
  \str_set:Ne \l__jsonparse_input_str {#1}
  \str_remove_all:Nn \l__jsonparse_input_str { ~ }
  \str_case:enF { 
    \str_lowercase:f { \l__jsonparse_input_str } 
  } {
    { true } {
      \str_set:Ne \l__jsonparse_val_str { 
        \l_jsonparse_true_str 
      }
      \prop_gput:Nee \g_jsonparse_entries_prop 
        { \l__jsonparse_key_str } { \l__jsonparse_val_str }
      % true
      \bool_if:NT \l_jsonparse_debug_mode_bool {
        \msg_log:nne { jsonparse } { debug-info } {
          (key) ~ \str_use:N \l__jsonparse_key_str : \iow_newline:
          \iow_char:N \  \iow_char:N \  (tru) ~ \str_use:N \l__jsonparse_val_str
        } 
      }  
    }
    { false } {
      \str_set:Ne \l__jsonparse_val_str { 
        \l_jsonparse_false_str 
      }
      \prop_gput:Nee \g_jsonparse_entries_prop 
        { \l__jsonparse_key_str } { \l__jsonparse_val_str }
      % false
      \bool_if:NT \l_jsonparse_debug_mode_bool {
        \msg_log:nne { jsonparse } { debug-info } {
          (key) ~ \str_use:N \l__jsonparse_key_str : \iow_newline:
          \iow_char:N \  \iow_char:N \  (fal) ~ \str_use:N \l__jsonparse_val_str
        } 
      }
    }
    { null } {
      \str_set:Ne \l__jsonparse_val_str { 
        \l_jsonparse_null_str 
      }
      \prop_gput:Nee \g_jsonparse_entries_prop 
        { \l__jsonparse_key_str } { \l__jsonparse_val_str }
      % null
      \bool_if:NT \l_jsonparse_debug_mode_bool {
        \msg_log:nne { jsonparse } { debug-info } {
          (key) ~ \str_use:N \l__jsonparse_key_str : \iow_newline:
          \iow_char:N \  \iow_char:N \  (nul) ~ \str_use:N \l__jsonparse_val_str
        } 
      }
    }
  } {
    \fp_compare:nNnTF {#1} ? { 0 } { 
      % nan
      \msg_error:nnee { jsonparse } { parsing-error }
        { \l__jsonparse_key_str } {#1}
    } { 
      \str_set:Ne \l__jsonparse_val_str {#1}
      \prop_gput:Nee \g_jsonparse_entries_prop 
        { \l__jsonparse_key_str } { \l__jsonparse_val_str }
      % number
      \bool_if:NT \l_jsonparse_debug_mode_bool {
        \msg_log:nne { jsonparse } { debug-info } {
          (key) ~ \str_use:N \l__jsonparse_key_str : \iow_newline:
          \iow_char:N \  \iow_char:N \  (num) ~ \str_use:N \l__jsonparse_val_str
        } 
      }
    }
  }
  \_jsonparse_remove_leading_spaces:N \l__jsonparse_remainder_str
  \str_set:Ne \l__jsonparse_remainder_str { 
    \str_range:een { \l__jsonparse_remainder_str } { 
      \int_eval:n {
        \str_count:e { #1 } + 1 
      }
    } { -1 }
  }
  \__jsonparse_parse_remainder:
}

\cs_new:Npn \__jsonparse_parse_remainder: {
  \_jsonparse_remove_leading_spaces:N \l__jsonparse_remainder_str
  \str_if_eq:enT { \str_head_ignore_spaces:e { \l__jsonparse_remainder_str } } { , } {
    \str_remove_once:Nn \l__jsonparse_remainder_str { , }
  }
  \str_if_empty:NTF \l__jsonparse_remainder_str {
    \bool_if:NT \l_jsonparse_debug_mode_bool {
      \msg_log:nne { jsonparse } { debug-info } {
        JSON ~ parsing ~ done. \iow_newline: 
      } 
    }
  } {
    \exp_args:Ne \jsonparse_parse:n { \l__jsonparse_remainder_str }
  }
}	

% ===

\NewExpandableDocumentCommand { \JSONParse } { m m } {
  \prop_new:N #1
  \jsonparse_parse_data:Nn #1 { #2 } 
}

\NewExpandableDocumentCommand { \JSONParseFromFile } { m m } {
  \ior_open:Nn \l__jsonparse_json_ior {#2}
  
  \str_clear:N \l__jsonparse_json_str
  \ior_str_map_inline:Nn \l__jsonparse_json_ior {
    \str_put_right:Nn \l__jsonparse_json_str {##1}
  }
  
  \ior_close:N \l__jsonparse_json_ior

  \prop_new:N #1
  \jsonparse_parse_to_tl:Nn #1 { \l__jsonparse_json_str } 
}

\NewExpandableDocumentCommand { \JSONParseGetValue } { m m } {
  \prop_item:Nn #1 { #2 }
}

\NewExpandableDocumentCommand { \JSONParseGetArrayValues } { m m O{} m } {
  \str_set:Ne \l__jsonparse_array_prefix_str { #2 \l_jsonparse_array_sep_left_str }
  \bool_set_true:N \l__prop_map_first_bool
  \prop_map_inline:Nn #1 {
    \str_if_eq:eeT { 
      \str_range:nne {##1} { 1 } { \str_count:N \l__jsonparse_array_prefix_str } 
    } { \l__jsonparse_array_prefix_str } {
      \str_if_eq:enT { 
        \str_range:nen {##1} { \int_eval:n { -1 * \str_count:n {#3} } } { -1 } 
      } {#3} {
        \bool_if:NTF \l__prop_map_first_bool { 
          \bool_set_false:N \l__prop_map_first_bool
        } {        
          #4 
        }
        ##2
      }
    } 
  }
}

\NewExpandableDocumentCommand { \JSONParseUseArrayValues } { m m O{} m } {
  \str_set:Ne \l__jsonparse_array_prefix_str { #2 \l_jsonparse_array_sep_left_str }
  \prop_map_inline:Nn #1 {
    \str_if_eq:eeT { 
      \str_range:nne {##1} { 1 } { \str_count:N \l__jsonparse_array_prefix_str } 
    } { \l__jsonparse_array_prefix_str } {
      \str_if_eq:enT { 
        \str_range:nen {##1} { \int_eval:n { -1 * \str_count:n {#3} } } { -1 } 
      } {#3} {
        \use:c {#4} { \prop_item:Nn #1 {##1} }
      }
    } 
  }
}

\NewExpandableDocumentCommand { \JSONParseObject } { m m m } {
  \prop_new:N #1
  \str_set:Ne \l__jsonparse_object_prefix_str { #3 \l_jsonparse_child_sep_str }
  \prop_map_inline:Nn #2 {
    \str_if_eq:eeT { 
      \str_range:nne {##1} { 1 } { \str_count:N \l__jsonparse_object_prefix_str } 
    } { \l__jsonparse_object_prefix_str } {
      \prop_put:Nen #1 {  
         \str_range:nee {##1} { \int_eval:n { \str_count:N \l__jsonparse_object_prefix_str + 1 } } { -1 } 
      } {##2}
    } 
  }
}

\NewExpandableDocumentCommand { \JSONParseArray } { m m m } {
  \prop_new:N #1
  \str_set:Ne \l__jsonparse_array_prefix_str { #3 \l_jsonparse_array_sep_left_str }
  \prop_map_inline:Nn #2 {
    \str_if_eq:eeT { 
      \str_range:nne {##1} { 1 } { \str_count:N \l__jsonparse_array_prefix_str } 
    } { \l__jsonparse_array_prefix_str } {
      \prop_put:Nen #1 {  
         \str_range:nee {##1} { \int_eval:n { \str_count:N \l__jsonparse_array_prefix_str } } { -1 } 
      } {##2}
    } 
  }
}

% EOF
